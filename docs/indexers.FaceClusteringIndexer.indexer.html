---

title: Face Clustering 


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/indexers.FaceClusteringIndexer.indexer.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/indexers.FaceClusteringIndexer.indexer.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FaceClusteringIndexer" class="doc_header"><code>class</code> <code>FaceClusteringIndexer</code><a href="integrators/indexers/faceclustering/indexer.py#L23" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FaceClusteringIndexer</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>IndexerBase</code></p>
</blockquote>
<p>Clusters faces on photos.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_registration</span><span class="p">(</span><span class="n">FaceClusteringIndexer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Toy-dataset">Toy dataset<a class="anchor-link" href="#Toy-dataset"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can test the model on your favorite images, we use 2 images from the modern family tv show as input and run the indexer. As per usual, you can run the indexer by calling indexer.index().</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">PYI_TESTDATA</span> <span class="o">/</span> <span class="s2">&quot;photos&quot;</span> <span class="o">/</span> <span class="s2">&quot;faceclustering&quot;</span>
<span class="n">photos</span> <span class="o">=</span> <span class="p">[</span><span class="n">IPhoto</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">640</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_dir</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;jpg&quot;</span><span class="p">)]</span>
<span class="n">data</span>   <span class="o">=</span> <span class="n">IndexerData</span><span class="p">(</span><span class="n">photos</span><span class="o">=</span><span class="n">photos</span><span class="p">)</span>
<span class="n">cluster_indexer</span> <span class="o">=</span> <span class="n">FaceClusteringIndexer</span><span class="p">()</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">cluster_indexer</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[32, 16, 8] {&#39;32&#39;: {&#39;SCALES&#39;: (32, 16), &#39;BASE_SIZE&#39;: 16, &#39;RATIOS&#39;: (1.0,), &#39;ALLOWED_BORDER&#39;: 9999}, &#39;16&#39;: {&#39;SCALES&#39;: (8, 4), &#39;BASE_SIZE&#39;: 16, &#39;RATIOS&#39;: (1.0,), &#39;ALLOWED_BORDER&#39;: 9999}, &#39;8&#39;: {&#39;SCALES&#39;: (2, 1), &#39;BASE_SIZE&#39;: 16, &#39;RATIOS&#39;: (1.0,), &#39;ALLOWED_BORDER&#39;: 9999}}
use_landmarks True
Indexing 2 photos
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='2' class='' max='2' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [2/2 00:01<00:00]
    </div>
    
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='22' class='' max='22' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [22/22 00:03<00:00]
    </div>
    
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inspecting-the-output">Inspecting the output<a class="anchor-link" href="#Inspecting-the-output"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This generates a few data items for you, from various types. It creates photos and their files, which correspond to the crops of the faces and it creates Person items for the people in the crops.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">set</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{integrators.data.schema.File,
 integrators.data.schema.Person,
 integrators.indexers.facerecognition.photo.IPhoto}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Person and Photo items are connected with an edge, called "occurence", you can inspect them as follows:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">people</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Person</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">occurence</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">people</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>7
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simluate-run-from-pod">Simluate run from pod<a class="anchor-link" href="#Simluate-run-from-pod"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can also test the full pipelines as if you are running it from the pod. You can do that as follows.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">PodClient</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">PYI_TESTDATA</span> <span class="o">/</span> <span class="s2">&quot;photos&quot;</span> <span class="o">/</span> <span class="s2">&quot;faceclustering&quot;</span>
<span class="n">photos</span> <span class="o">=</span> <span class="p">[</span><span class="n">IPhoto</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">640</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_dir</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;jpg&quot;</span><span class="p">)]</span>
<span class="n">indexer</span> <span class="o">=</span> <span class="n">Indexer</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">indexerClass</span><span class="o">=</span><span class="s2">&quot;FaceClusteringIndexer&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FaceClustering&quot;</span><span class="p">)</span>
<span class="n">indexer_run</span> <span class="o">=</span> <span class="n">IndexerRun</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">targetDataType</span><span class="o">=</span><span class="s2">&quot;Photo&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">indexer</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">]</span> <span class="o">+</span> <span class="n">photos</span> <span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">create_edge</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">indexer_run</span><span class="p">,</span> <span class="n">indexer</span><span class="p">,</span> <span class="s2">&quot;indexer&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run_integrator</span><span class="p">(</span><span class="n">pod_full_address</span><span class="o">=</span><span class="n">DEFAULT_POD_ADDRESS</span><span class="p">,</span>
               <span class="n">integrator_run_uid</span><span class="o">=</span><span class="n">indexer_run</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
               <span class="n">database_key</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">database_key</span><span class="p">,</span>
               <span class="n">owner_key</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">owner_key</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">delete_all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[32, 16, 8] {&#39;32&#39;: {&#39;SCALES&#39;: (32, 16), &#39;BASE_SIZE&#39;: 16, &#39;RATIOS&#39;: (1.0,), &#39;ALLOWED_BORDER&#39;: 9999}, &#39;16&#39;: {&#39;SCALES&#39;: (8, 4), &#39;BASE_SIZE&#39;: 16, &#39;RATIOS&#39;: (1.0,), &#39;ALLOWED_BORDER&#39;: 9999}, &#39;8&#39;: {&#39;SCALES&#39;: (2, 1), &#39;BASE_SIZE&#39;: 16, &#39;RATIOS&#39;: (1.0,), &#39;ALLOWED_BORDER&#39;: 9999}}
use_landmarks True
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

