---

title: Indexer


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/indexers.indexer.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/indexers.indexer.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IndexerBase" class="doc_header"><code>class</code> <code>IndexerBase</code><a href="https://gitlab.memri.io/memri/pyintegrators/tree/prod/pyintegrators/indexers/indexer.py#L20" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IndexerBase</code>(<strong><code>indexerClass</code></strong>=<em><code>None</code></em>, <strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Indexer</code></p>
</blockquote>
<p>Provides a base class for all items. All items in the schema inherit from this class, and it provides some
basic functionality for consistency and to enable easier usage.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IndexerData" class="doc_header"><code>class</code> <code>IndexerData</code><a href="https://gitlab.memri.io/memri/pyintegrators/tree/prod/pyintegrators/indexers/indexer.py#L51" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IndexerData</code>(<strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_indexer_run_data" class="doc_header"><code>get_indexer_run_data</code><a href="https://gitlab.memri.io/memri/pyintegrators/tree/prod/pyintegrators/indexers/indexer.py#L60" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_indexer_run_data</code>(<strong><code>client</code></strong>, <strong><code>indexer_run</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="test_registration" class="doc_header"><code>test_registration</code><a href="https://gitlab.memri.io/memri/pyintegrators/tree/prod/pyintegrators/indexers/indexer.py#L66" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>test_registration</code>(<strong><code>integrator</code></strong>)</p>
</blockquote>
<p>Check whether an integrator is registred. Registration is necessary to be able to load the right indexer
when retrieving it from the database.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Running-your-own-indexer">Running your own indexer<a class="anchor-link" href="#Running-your-own-indexer"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When we run an indexer we have four steps. 1) Get the indexer and indexer run based on the run uid. 2) run the indexer 3) populate the graph with the new information. To mock that, first we create a client and add some toy data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_integrator" class="doc_header"><code>run_integrator</code><a href="https://gitlab.memri.io/memri/pyintegrators/tree/prod/pyintegrators/indexers/indexer.py#L97" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_integrator</code>(<strong><code>environ</code></strong>=<em><code>None</code></em>, <strong><code>pod_full_address</code></strong>=<em><code>None</code></em>, <strong><code>integrator_run_uid</code></strong>=<em><code>None</code></em>, <strong><code>database_key</code></strong>=<em><code>None</code></em>, <strong><code>owner_key</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Runs an integrator, you can either provide the run settings as parameters to this function (for local testing)
or via environment variables (this is how the pod communicates with integrators).</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">integrators.indexers.geo.geo_indexer</span> <span class="kn">import</span> <span class="n">GeoIndexer</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">PodClient</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_toy_dataset</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">latitude</span><span class="o">=-</span><span class="mf">37.81</span><span class="p">,</span> <span class="n">longitude</span><span class="o">=</span><span class="mf">144.96</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">from_data</span><span class="p">()</span>
    <span class="n">indexer</span> <span class="o">=</span> <span class="n">Indexer</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">indexerClass</span><span class="o">=</span><span class="s2">&quot;GeoIndexer&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;GeoIndexer&quot;</span><span class="p">)</span>
    <span class="n">indexer_run</span> <span class="o">=</span> <span class="n">IndexerRun</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">targetDataType</span><span class="o">=</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">location</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">indexer</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">]:</span> <span class="n">client</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">create_edge</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">indexer_run</span><span class="p">,</span> <span class="n">indexer</span><span class="p">,</span> <span class="s2">&quot;indexer&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">client</span><span class="o">.</span><span class="n">create_edge</span><span class="p">(</span><span class="n">Edge</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">indexer</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">address</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Running-an-indexer-by-providing-environment-variables">Running an indexer by providing environment variables<a class="anchor-link" href="#Running-an-indexer-by-providing-environment-variables"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="generate_test_env" class="doc_header"><code>generate_test_env</code><a href="https://gitlab.memri.io/memri/pyintegrators/tree/prod/pyintegrators/indexers/indexer.py#L129" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>generate_test_env</code>(<strong><code>client</code></strong>, <strong><code>indexer_run</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">indexer</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">create_toy_dataset</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run_integrator</span><span class="p">(</span><span class="n">environ</span><span class="o">=</span><span class="n">generate_test_env</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Reading run parameters from environment variables
1 items found to index
indexing 1 items
Loading formatted geocoded file...
updating IndexerRun (#4)
creating Country (#None)
updating Address (#2)
updating Country (#5)
updating Address (#2)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">delete_all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run">Run<a class="anchor-link" href="#Run"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we start with the setting we would normally have: some memri client makes a call to the pod to execute an indexer run. Lets start by getting the indexer and the indexer run.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">indexer</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">create_toy_dataset</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="n">uid</span> <span class="o">=</span> <span class="n">indexer_run</span><span class="o">.</span><span class="n">uid</span><span class="p">;</span> <span class="n">uid</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>9</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">indexer_run</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
<span class="n">indexer</span> <span class="o">=</span> <span class="n">indexer_run</span><span class="o">.</span><span class="n">indexer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">indexer</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>GeoIndexer (#8)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we retrieve the data, which was specified in the client by the <code>targetDataType</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1 items found to index
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>IndexerData 
{&#39;items_with_location&#39;: [Address (#7)]}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">output_items</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>indexing 1 items
updating IndexerRun (#9)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">indexer</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">output_items</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>creating Country (#None)
updating Address (#7)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">delete_all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Running-the-full-Indexer-pipeline">Running the full Indexer pipeline<a class="anchor-link" href="#Running-the-full-Indexer-pipeline"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Running-an-indexer-by-providing-parameters-as-variables">Running an indexer by providing parameters as variables<a class="anchor-link" href="#Running-an-indexer-by-providing-parameters-as-variables"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">indexer</span><span class="p">,</span> <span class="n">indexer_run</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">create_toy_dataset</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="n">run_integrator</span><span class="p">(</span><span class="n">pod_full_address</span><span class="o">=</span><span class="n">DEFAULT_POD_ADDRESS</span><span class="p">,</span>
               <span class="n">integrator_run_uid</span><span class="o">=</span><span class="n">indexer_run</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
               <span class="n">database_key</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">database_key</span><span class="p">,</span>
               <span class="n">owner_key</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">owner_key</span><span class="p">)</span>

<span class="n">client</span><span class="o">.</span><span class="n">delete_all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1 items found to index
indexing 1 items
updating IndexerRun (#14)
creating Country (#None)
updating Address (#12)
updating Country (#15)
updating Address (#12)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Registration">Registration<a class="anchor-link" href="#Registration"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All indexers need to be registred before they can be ran. We can test our registration as follows</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_registration</span><span class="p">(</span><span class="n">GeoIndexer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include important.html content='Note that before running an indexer, it needs to be registered. We can do this by importing the file in <code>integrators.indexer_registry.py</code>.' %}</p>

</div>
</div>
</div>
</div>
 

